<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>ğŸ¬ Who's that Actor?</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      overflow: hidden;
    }
    
    .container {
      max-width: 500px;
      width: 100%;
      height: 100vh;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 15px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      text-align: center;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    h1 {
      font-size: 1.5rem;
      margin: 0 0 5px 0;
    }
    
    .subtitle {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 10px;
    }
    
    .camera-container {
      width: 100%;
      flex: 1;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 15px;
      margin-bottom: 10px;
      overflow: hidden;
      position: relative;
      min-height: 200px;
    }
    
    video, img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 15px;
    }
    
    .hidden {
      display: none;
    }
    
    .controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: #3498db;
      color: white;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      transition: all 0.3s ease;
      flex: 1;
      min-width: 120px;
    }
    
    button:hover {
      transform: translateY(-2px);
    }
    
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .big-button {
      background: linear-gradient(45deg, #ff6b6b, #ee5a24);
      font-size: 16px;
      padding: 15px 25px;
    }
    
    #status {
      padding: 8px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      margin-bottom: 10px;
      font-size: 0.9rem;
      min-height: 15px;
    }
    
    .error {
      background: rgba(231, 76, 60, 0.3);
      color: #fff;
    }
    
    .success {
      background: rgba(39, 174, 96, 0.3);
      color: #fff;
    }
    
    input[type="file"] {
      display: none;
    }
    
    #results {
      font-size: 0.8rem;
      max-height: 80px;
      overflow-y: auto;
    }
    
    #results ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    #results li {
      background: rgba(255, 255, 255, 0.1);
      margin: 3px 0;
      padding: 8px;
      border-radius: 8px;
      border-left: 3px solid #27ae60;
      font-size: 0.8rem;
    }
    
    #results a {
      color: #74b9ff !important;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.7rem;
    }
    
    #debug {
      display: none;
    }
    
    @media (max-height: 700px) {
      .container {
        padding: 10px;
      }
      
      h1 {
        font-size: 1.3rem;
      }
      
      .subtitle {
        font-size: 0.8rem;
      }
      
      button {
        padding: 10px 15px;
        font-size: 13px;
      }
      
      .camera-container {
        min-height: 150px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ Who's that Actor?</h1>
    <p class="subtitle">Snap any actor on your TV screen!</p>
    
    <div id="status">Ready to start</div>
    
    <div class="camera-container">
      <video id="video" class="hidden" autoplay muted playsinline></video>
      <img id="preview" class="hidden" alt="Captured photo" />
      <div id="placeholder" style="display: flex; align-items: center; justify-content: center; height: 100%; color: rgba(255,255,255,0.5); font-size: 3rem;">
        ğŸ“·
      </div>
    </div>

    <div class="controls">
      <button id="startBtn" class="big-button">ğŸ“· START</button>
      <button id="snapBtn" class="hidden" disabled>ğŸ“¸ SNAP</button>
      <button id="uploadBtn" onclick="document.getElementById('fileInput').click()">ğŸ“‚ UPLOAD</button>
      <input type="file" id="fileInput" accept="image/*">
      <button id="analyzeBtn" class="hidden" disabled>ğŸ” ANALYZE</button>
      <button id="retakeBtn" class="hidden">ğŸ”„ RETAKE</button>
    </div>

    <div id="results"></div>
    <div id="debug"></div>
  </div>

  <script>
    // Simple global variables
    let video = document.getElementById('video');
    let preview = document.getElementById('preview');
    let placeholder = document.getElementById('placeholder');
    let status = document.getElementById('status');
    let debug = document.getElementById('debug');
    let startBtn = document.getElementById('startBtn');
    let snapBtn = document.getElementById('snapBtn');
    let uploadBtn = document.getElementById('uploadBtn');
    let analyzeBtn = document.getElementById('analyzeBtn');
    let retakeBtn = document.getElementById('retakeBtn');
    let fileInput = document.getElementById('fileInput');
    let results = document.getElementById('results');
    
    let currentStream = null;
    let currentBlob = null;
    
    // Debug logging
    function log(message) {
      console.log(message);
      debug.innerHTML += new Date().toLocaleTimeString() + ': ' + message + '<br>';
      debug.scrollTop = debug.scrollHeight;
    }
    
    // Check device
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isSafari = /Safari/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent);
    const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
    
    log('ğŸ“± Device: ' + (isIOS ? 'iOS' : 'Desktop'));
    log('ğŸŒ Browser: ' + (isSafari ? 'Safari' : 'Other'));
    log('ğŸ”’ Secure: ' + (isSecure ? 'Yes' : 'No'));
    
    // Check requirements
    if (isIOS && !isSecure) {
      status.innerHTML = 'âš ï¸ HTTPS required for camera on iPhone';
      status.className = 'error';
      startBtn.disabled = true;
    }
    
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      status.innerHTML = 'âŒ Camera not supported in this browser';
      status.className = 'error';
      startBtn.disabled = true;
    }
    
    // Start camera button
    startBtn.onclick = async function() {
      log('ğŸ‘† Start button clicked');
      
      startBtn.disabled = true;
      startBtn.textContent = 'ğŸ“± Starting camera...';
      status.textContent = 'Requesting camera access...';
      status.className = '';
      
      try {
        log('ğŸ¬ Requesting camera...');
        
        // Simplest possible camera request
        currentStream = await navigator.mediaDevices.getUserMedia({
          video: true
        });
        
        log('âœ… Camera stream obtained');
        
        // Set up video
        video.srcObject = currentStream;
        video.classList.remove('hidden');
        placeholder.style.display = 'none';
        
        // Wait for video to load
        video.onloadedmetadata = function() {
          log('ğŸ“º Video loaded: ' + video.videoWidth + 'x' + video.videoHeight);
          
          // Show snap button
          startBtn.classList.add('hidden');
          snapBtn.classList.remove('hidden');
          snapBtn.disabled = false;
          
          status.textContent = 'âœ… Camera ready! Point at TV and snap photo';
          status.className = 'success';
        };
        
        // Fallback - enable after 3 seconds
        setTimeout(function() {
          if (snapBtn.disabled && currentStream) {
            log('â° Force enabling snap button');
            snapBtn.disabled = false;
            status.textContent = 'ğŸ“¸ Camera ready - you can snap photos';
            status.className = 'success';
          }
        }, 3000);
        
      } catch (err) {
        log('âŒ Camera failed: ' + err.name + ' - ' + err.message);
        
        startBtn.disabled = false;
        startBtn.textContent = 'âŒ TRY AGAIN';
        
        if (err.name === 'NotAllowedError') {
          status.innerHTML = 'ğŸš« Camera permission denied<br><small>Check Safari settings or try refreshing</small>';
        } else if (err.name === 'NotFoundError') {
          status.innerHTML = 'ğŸ“· No camera found<br><small>Make sure camera is available</small>';
        } else {
          status.innerHTML = 'âŒ Camera error: ' + err.message;
        }
        status.className = 'error';
      }
    };
    
    // Snap photo
    snapBtn.onclick = function() {
      log('ğŸ“¸ Snap button clicked');
      
      try {
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth || 640;
        canvas.height = video.videoHeight || 480;
        
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0);
        
        // Convert to blob
        canvas.toBlob(function(blob) {
          if (blob) {
            log('âœ… Photo captured: ' + Math.round(blob.size / 1024) + 'KB');
            
            currentBlob = blob;
            
            // Show preview
            preview.src = URL.createObjectURL(blob);
            preview.classList.remove('hidden');
            video.classList.add('hidden');
            
            // Update UI
            snapBtn.classList.add('hidden');
            analyzeBtn.classList.remove('hidden');
            analyzeBtn.disabled = false;
            retakeBtn.classList.remove('hidden');
            
            status.textContent = 'ğŸ“¸ Photo captured! Ready to analyze';
            status.className = 'success';
          } else {
            log('âŒ Failed to create blob');
            status.textContent = 'âŒ Failed to capture photo';
            status.className = 'error';
          }
        }, 'image/jpeg', 0.8);
        
      } catch (err) {
        log('âŒ Snap failed: ' + err.message);
        status.textContent = 'âŒ Failed to capture: ' + err.message;
        status.className = 'error';
      }
    };
    
    // File upload
    fileInput.onchange = function() {
      if (this.files[0]) {
        log('ğŸ“ File uploaded: ' + Math.round(this.files[0].size / 1024) + 'KB');
        
        currentBlob = this.files[0];
        
        // Show preview
        preview.src = URL.createObjectURL(currentBlob);
        preview.classList.remove('hidden');
        video.classList.add('hidden');
        placeholder.style.display = 'none';
        
        // Stop camera if running
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
          currentStream = null;
        }
        
        // Update UI
        startBtn.classList.add('hidden');
        snapBtn.classList.add('hidden');
        analyzeBtn.classList.remove('hidden');
        analyzeBtn.disabled = false;
        retakeBtn.classList.remove('hidden');
        retakeBtn.textContent = 'ğŸ”„ CHOOSE ANOTHER';
        
        status.textContent = 'ğŸ“ Photo uploaded! Ready to analyze';
        status.className = 'success';
      }
    };
    
    // Analyze with AWS - Using a working method
    analyzeBtn.onclick = async function() {
      if (!currentBlob) return;
      
      log('ğŸ” Starting analysis...');
      
      analyzeBtn.disabled = true;
      analyzeBtn.textContent = 'ğŸ” ANALYZING...';
      status.textContent = 'ğŸ“¤ Uploading to AWS Rekognition...';
      status.className = '';
      
      try {
        // For now, simulate the AWS response since direct API calls need complex authentication
        // In a real app, you'd use AWS SDK or a backend service
        
        log('ğŸ” Simulating AWS analysis...');
        
        // Simulate processing time
        await new Promise(resolve => setTimeout(resolve, 2000));
        
        // Mock celebrity data for demonstration
        const mockResponse = {
          CelebrityFaces: [
            {
              Name: "Leonardo DiCaprio",
              MatchConfidence: 98.7,
              Urls: ["https://www.imdb.com/name/nm0000138/"]
            },
            {
              Name: "Jennifer Lawrence", 
              MatchConfidence: 95.3,
              Urls: ["https://www.imdb.com/name/nm2225369/"]
            }
          ]
        };
        
        // Randomly select 1-2 celebrities for demo
        const numCelebs = Math.floor(Math.random() * 2) + 1;
        const selectedCelebs = mockResponse.CelebrityFaces.slice(0, numCelebs);
        
        const data = { CelebrityFaces: selectedCelebs };
        
        log('ğŸ“¥ Analysis complete: ' + data.CelebrityFaces?.length + ' celebrities found');
        
        if (data.CelebrityFaces && data.CelebrityFaces.length > 0) {
          // Create results with IMDb links
          let resultsHTML = '<h3>ğŸ‰ Found celebrities:</h3><ul>';
          
          data.CelebrityFaces.forEach(celebrity => {
            const confidence = celebrity.MatchConfidence.toFixed(1);
            let imdbLink = '';
            
            // Check if celebrity has URLs (including IMDb)
            if (celebrity.Urls && celebrity.Urls.length > 0) {
              const imdbUrl = celebrity.Urls.find(url => url.includes('imdb.com'));
              if (imdbUrl) {
                imdbLink = `<br><a href="${imdbUrl}" target="_blank" style="color: #74b9ff; text-decoration: none; font-size: 14px;">ğŸ“º View on IMDb â†’</a>`;
              }
            }
            
            resultsHTML += `
              <li>
                <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap;">
                  <div style="flex: 1;">
                    <strong style="font-size: 18px;">${celebrity.Name}</strong>
                    ${imdbLink}
                  </div>
                  <div style="background: rgba(39, 174, 96, 0.3); padding: 8px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; margin-left: 10px;">
                    ${confidence}%
                  </div>
                </div>
              </li>
            `;
          });
          
          resultsHTML += '</ul>';
          
          // Add note about demo
          resultsHTML += '<p style="font-size: 12px; opacity: 0.8; margin-top: 15px;"><em>Note: This is currently showing demo data. To enable real AWS celebrity recognition, you need to set up proper AWS authentication.</em></p>';
          
          results.innerHTML = resultsHTML;
          
          status.textContent = 'ğŸ‰ Found ' + data.CelebrityFaces.length + ' celebrities!';
          status.className = 'success';
        } else {
          status.textContent = 'ğŸ˜• No celebrities found in this image';
          status.className = 'error';
        }
        
      } catch (err) {
        log('âŒ Analysis failed: ' + err.message);
        status.textContent = 'âŒ Analysis failed: ' + err.message;
        status.className = 'error';
      } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.textContent = 'ğŸ” ANALYZE PHOTO';
      }
    };
    
    // Retake/restart
    retakeBtn.onclick = function() {
      log('ğŸ”„ Retake button clicked');
      
      // Reset UI
      preview.classList.add('hidden');
      analyzeBtn.classList.add('hidden');
      retakeBtn.classList.add('hidden');
      results.innerHTML = '';
      
      if (currentStream) {
        // Camera is still running - go back to snap
        video.classList.remove('hidden');
        snapBtn.classList.remove('hidden');
        snapBtn.disabled = false;
        status.textContent = 'ğŸ“¸ Point at TV and snap photo';
        status.className = 'success';
      } else {
        // No camera - show start button
        placeholder.style.display = 'flex';
        startBtn.classList.remove('hidden');
        startBtn.disabled = false;
        startBtn.textContent = 'ğŸ“· START CAMERA';
        retakeBtn.textContent = 'ğŸ”„ RETAKE';
        status.textContent = 'Ready to start';
        status.className = '';
      }
    };
    
    log('ğŸ¬ App ready!');
  </script>
</body>
</html>
